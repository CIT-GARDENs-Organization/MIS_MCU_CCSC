<div align="center">
    <img src="https://github.com/user-attachments/assets/099b80dd-a6a5-4a14-940f-06401dadf024" width="200" alt="GARDENs logo" />
   <h1>MIS MCU source(PIC)</h1>
</div>

## 概要  
本リポジトリは、GARDENsのMIS MCU(PIC)に実装するソースコードの基盤を提供するものである。
これを基に各ミッションへ派生させることによる以下の実現を目的とする。

- **開発効率の向上**  
- **担当領域の明確化**  
- **統一された挙動による試験・運用の円滑化**  

---

## 実装方法  
1. 初期設定
  1.  `config.h` **`#pin_select`** → それぞれ適切なものに変更する  
  2. `define.h` **27行目** → `#SELF_DEVICE_ID` を、14 ~ 25行目の定数の中から適切なものに選択する。
  3. `DataCopy.h` **4行目** → SMFのメモリマップのIICDに基づいたアドレスを記載する。
2. ミッションの実装
  1. `Missoin.h` **20行目以降** → 実装するミッションの関数名を記入する。返り値は`void`、引数は`(unsigned int8 parameter[])`である。
  2. `Mission.c` **40行目** → 先程の関数をswitch-caseの中に追記する。
  3. `Mission.c` **97行目** → 先程の関数の実装をする。

---

## 制約 & その他  

### **禁止事項**  
- `Mission.c`・`Mission.h`**以外のファイル**の編集 (先の初期設定を除く)

### **許可事項**
- `Mission.c`・`Mission.h`内の上記以外の目的の編集
- 新規ファイル作成

### **SMFデータの保存ルール**  
- 各々の実装した関数内で以下の関数を使用する。
```
void enqueue_smf_data(unsigned int32 src, unsigned int32 dest, unsigned int32 size);
```
- src  → 各々のフラッシュメモリーがもつ、コピーする保存領域の開始アドレス
- dest → SMFへのコピー先の開始アドレス
- size → コピーするデータサイズ

### **割り込み関数の無効化**
- センサリング系のミッションで厳密な測定結果を要する場合、**TIMER0**割り込みを無効化して構わない。
- **INT_RDA**割り込みの無効化は、BOSS PICがMIS MCUの異常終了とみなしてしまうため禁止する。

### **ミッション連続実行**
- MIS MCUは、地上局からの連続アップリンクで誤動作しないようにするため同じミッションをその機器の起動中に実行しないようにしている。
　- もし、意図的に連続で実行したい、する予定ミッションがある場合、そのミッションで以下の関数を実行する
```
void executed_mission_pop(void);
```

### 使用可能なグローバル変数
> [!CAUTION]
> 参照は許可するが、値の変更は禁止する。
- 時間系
  - `dsec` → deci secondsの意。10分の1秒。常にTIMER0割り込みで更新される。
  - `sec` → secondsの意。常にTIMER0割り込みで更新される。Uplink command受信時、RESET PICから配信される衛星内経過時間に更新される。
  - `day` → 変数名そのままの意。sec同様である。

---

## 今後の更新予定 (作業担当者: GARDENs)
1. SMFへのコピー機能の実装
   - 現在はprint出力でSMFへのコピーを模しているが、今後実際に機能を開発し統一されたSMFへのコピー機能を搭載する。
2. ミッション実行後継続起動機能
   - 現在はミッション実行後、SMFへ書き込むものがない場合に、BOSS PICからStatus checkフレームを受信した後に停止する動作を取る。
   - もし特定のミッション実行後、連続して同一の・他のミッションの実行を望む場合、**SMFへのコピー事項、Uplink commandの受信がなくとも、最低でもXX秒の起動を保証する(24h, 異常時を除く)**という機能を実装する予定である。
